# %%%%%%%%%%%%%%%%%%%%%%
# %%% PLOT STRUCTURE %%%
# %%%%%%%%%%%%%%%%%%%%%%

# This script declares a function for taking the the summarized Q matrix values 
# from a CLUMPP run and building a corresponding STRUCTURE plot.Specifically, 
# in terms of the outputs from CLUMPAK, for a given K value, it reads
# in the CLUMPP output file ("CLUMPP.files/ClumppIndFile,output") 
# and will plot those values.

# It then uses that function to plot the STRUCTURE outputs for QUAC and QUBO datasets,
# using garden and wild samples as well as wild samples only

library(RColorBrewer)

# %%%% FUNCTIONS %%%% ----
# Read in the file generated by CLUMPP, and add/remove columns as required 
read.CLUMPP <- function(clumpp.outputFile){
  # Read int the CLUMPP output file
  Qmat <- read.table(clumpp.outputFile, header=FALSE)
  # Remove the first 5 columns, which contain sample identifiers and other characters
  Qmat <- Qmat[,-(1:5)]
  return(Qmat)
}

# Plotting function for K of a single value
plot_singleK <- function(kList, kColors, ...){
  # Graphing parameters
  par(mar=c(7,2,6,3)+0.1, mgp = c(3,1,1))
  # Plotting 
  for(i in 1:length(kList)){
    if(i==1){
      # Initial barplot
      barplot(kList[,i], xlim=c(0,(nrow(kList)+20)), horiz=F, beside=F, col=kColors[i], 
              axisnames=T, space=0.2, yaxt= "n", main="")
      off.value <- kList[,i]
    }else{
      # Subsequent barplots with offset
      barplot(kList[,i], offset=off.value, add=T, beside=F, xlim=c(0,(nrow(kList)+20)), 
              horiz=F, col=kColors[i], yaxt= "n")
      off.value <- off.value + kList[,i]
    }
  }
  # y axis
  axis(2, at = c(0, 0.25, 0.5, 0.75, 1), labels=c("0", "0.25", "0.50", "0.75", "1.00"), cex.axis = 1, las = 2, pos = -0.2, xpd=T)
}

plot_singleK <- function(kList, kColors, ...){
  # Graphing parameters
  par(mar=c(7,2,6,3)+0.1, mgp = c(3,1,1))
  # Plotting 
  for(i in 1:length(kList)){
    if(i==1){
      # Initial barplot
      barplot(kList[,i], xlim=c(0,(nrow(kList)+20)), horiz=F, beside=F, col=kColors[i], 
              axisnames=T, space=0.2, yaxt= "n", main="")
      off.value <- kList[,i]
    }else{
      if(i > 96){
        # Subsequent barplots with offset
        barplot(kList[,i], offset=off.value, add=T, beside=F, xlim=c(0,(nrow(kList)+20)), 
                horiz=F, col="black", yaxt= "n")
        off.value <- off.value + kList[,i]
      } else {
        # Subsequent barplots with offset
        barplot(kList[,i], offset=off.value, add=T, beside=F, xlim=c(0,(nrow(kList)+20)), 
                horiz=F, col=kColors[i], yaxt= "n")
        off.value <- off.value + kList[,i]
      }
    }
  }
  # y axis
  axis(2, at = c(0, 0.25, 0.5, 0.75, 1), labels=c("0", "0.25", "0.50", "0.75", "1.00"), cex.axis = 1, las = 2, pos = -0.2, xpd=T)
}


# plot chains with species labels 
plot_multipleK <- function(nInds, kList, kValues, kColors, ...){
  # Define colors
  # cols <- c("#2171B5","#D95F02","#7570B3","#E7298A","#66A61E","#8C510A","#666666","#B3E2CD","#FDCDAC","#CBD5E8","#F4CAE4","#E6F5C9","#FFF2AE","#F1E2CC","#CCCCCC")
  # Set graphing parameters, in order to fit specified number of Ks
  par(mfrow = c(length(kList),1), mar = c(1.5,1,1.3,1) + 0.1, oma = c(5,0,1,0), mgp = c(2,1,0))
  # locations of each column
  # b <- as.data.frame(matrix(ncol = 1, nrow = nInds))
  # b[,1] <- barplot(t(kList[[1]][1]), beside= F, col= kColors, cex.name= 1, cex.axis= 1.2, border = 1, space = 0.05, xaxt = 'n', yaxt = 'n', cex.lab = 1, cex.main=1.6)
  # Plot 
  for(i in 1:length(kList)){
    # main plot call, and title call
    barplot(t(kList[[i]]), beside= F, col= kColors, border = 1, space = 0.05, xaxt = 'n', yaxt = 'n', cex.lab = 1.2)
    title(main = paste("K =", kValues[i], sep = ' '), line=0.2, cex.main=1.6)
    # y axis
    axis(2, at = c(0, 0.25, 0.5, 0.75, 1), cex.axis = 1, las = 2, pos = -0.02)
  }
}

# Function for plotting multiple
structure_plot <- function(nInds, klist, Ks, Kcolors){
  # define colors (16, for maximum number of Ks)
  # cols <- c("#2171B5","#D95F02","#7570B3","#E7298A","#66A61E","#8C510A","#666666","#B3E2CD","#FDCDAC","#CBD5E8","#F4CAE4","#E6F5C9","#FFF2AE","#F1E2CC","#CCCCCC")
  # locations of each column
  b <- as.data.frame(matrix(ncol = 1, nrow = nInds))
  b[,1] <- barplot(t(klist[[1]][1]), beside= F, col= Kcolors, cex.name= 1, cex.axis= 1.2, border = 1, space = 0.05, xaxt = 'n', yaxt = 'n', cex.lab = 1, cex.main=1.6)
  # plot
  plot_q_per_chain(klist, Ks)
}

# Plot chains with species labels 
plot_q_per_chain <- function(kqlist, Ks, ...){
  # Define colors
  cols <- c("#2171B5","#D95F02","#7570B3","#E7298A","#66A61E","#8C510A","#666666","#B3E2CD","#FDCDAC","#CBD5E8","#F4CAE4","#E6F5C9","#FFF2AE","#F1E2CC","#CCCCCC")
  # par(mfrow = c(length(kqlist),1), mar = c(1.5,1,1.3,1) + 0.1, oma = c(5,0,1,0), mgp = c(2,1,0))
  par(mfrow = c(length(kqlist),1), mar = c(4,1,1.3,1) + 0.1, oma = c(5,0,1,0), mgp = c(2,1,0))
  for(i in 1:length(kqlist)){
    # main plot call, and title call
    barplot(t(kqlist[[i]]), beside= F, col= cols, border = 1, space = 0.05, xaxt = 'n', yaxt = 'n', cex.lab = 1.2)
    title(main = paste("K =", Ks[i], sep = ' '), line=0.2, cex.main=1.6)
    # y axis
    axis(2, at = c(0, 0.25, 0.5, 0.75, 1), cex.axis = 1, las = 2, pos = -0.02)
  }
}

# %%%% QUAC %%%% ----
# Variable file path: directory containing all CLUMPPs output to read in
clumppDir <- 
  "/RAID1/IMLS_GCCO/Analysis/structure/denovo_finalAssemblies/QUAC/R80/garden_wild/firstSNP/output/CLUMPAK/QUAC_gardenAndWild_CLUMPAK/"

# Single K (QUAC garden and wild, K=6)
clummppFilepath <- paste0(clumppDir, "/K6/CLUMPP.files/ClumppIndFile.output")

test <- read.table(clummppFilepath, header=T)
test <- test[,-(1:5)]

testColors <- brewer.pal(6,"Dark2")
plot_singleK(test, kColors = testColors)

# Plotting lines beneath groups
lineWidth <- 1.9; lineHeight <- rep(-0.015,2)

lines(x = c(0.3,95.7), y = lineHeight, lwd = lineWidth, col = "black", xpd = NA)
lines(x = c(29.4,34.4), y = lineHeight, lwd = lineWidth, col = "black", xpd = NA)

# Multiple Ks (QUAC garden and wild, K=2-7)
K2filepath <- paste0(clumppDir, "/K2/CLUMPP.files/ClumppIndFile.output")
K2clumpp <- read.CLUMPP(K2filepath)

K3filepath <- paste0(clumppDir, "/K3/CLUMPP.files/ClumppIndFile.output")
K3clumpp <- read.CLUMPP(K3filepath)

K4filepath <- paste0(clumppDir, "/K4/CLUMPP.files/ClumppIndFile.output")
K4clumpp <- read.CLUMPP(K4filepath)

K5filepath <- paste0(clumppDir, "/K5/CLUMPP.files/ClumppIndFile.output")
K5clumpp <- read.CLUMPP(K5filepath)

K6filepath <- paste0(clumppDir, "/K6/CLUMPP.files/ClumppIndFile.output")
K6clumpp <- read.CLUMPP(K6filepath)

K7filepath <- paste0(clumppDir, "/K7/CLUMPP.files/ClumppIndFile.output")
K7clumpp <- read.CLUMPP(K7filepath)

K2_4 <- list(K2clumpp, K3clumpp, K4clumpp)
K5_7 <- list(K5clumpp, K6clumpp, K7clumpp)
K2_7 <- list(K2clumpp, K3clumpp, K4clumpp, 
             K5clumpp, K6clumpp, K7clumpp)

structure_plot(nInds = 193, klist = K2_4, Ks=(2:4), Kcolors = testColors)
structure_plot(nInds = 193, klist = K5_7, Ks=(5:7), Kcolors = testColors)
structure_plot(nInds = 193, klist = K2_7, Ks=(2:7), Kcolors = testColors)

# Designate groups beneath K charts. 1-96 are garden; 97-193 are wild
lineWidth <- 1.9; lineHeight <- rep(-0.1,2)
labelPositions <- c(48, 144); labelNames <- c("garden", "wild")

# Plot lines
lines(x = c(0.2,100), y = lineHeight, lwd = lineWidth, col = "black", xpd = NA)
lines(x = c(101.5,202.5), y = lineHeight, lwd = lineWidth, col = "black", xpd = NA)
# Add group labels
text(x=labelPositions, y=-0.2, srt=35, adj=1, xpd=TRUE, labels=labelNames, cex=1.2)

# %%%% QUBO %%%% ----
# Variable file path: directory containing all CLUMPPs output to read in
clumppDir <- 
  "/RAID1/IMLS_GCCO/Analysis/structure/reference_filteredReads/QUBO/R80/garden_wild/firstSNP/output/CLUMPAK/QUBO_gardenAndWild_CLUMPAK_1658769113/"

# Multiple Ks (QUBO garden and wild, K=2-8)
K2filepath <- paste0(clumppDir, "/K2/CLUMPP.files/ClumppIndFile.output")
K2clumpp <- read.CLUMPP(K2filepath)

K3filepath <- paste0(clumppDir, "/K3/CLUMPP.files/ClumppIndFile.output")
K3clumpp <- read.CLUMPP(K3filepath)

K4filepath <- paste0(clumppDir, "/K4/CLUMPP.files/ClumppIndFile.output")
K4clumpp <- read.CLUMPP(K4filepath)

K5filepath <- paste0(clumppDir, "/K5/CLUMPP.files/ClumppIndFile.output")
K5clumpp <- read.CLUMPP(K5filepath)

K6filepath <- paste0(clumppDir, "/K6/CLUMPP.files/ClumppIndFile.output")
K6clumpp <- read.CLUMPP(K6filepath)

K7filepath <- paste0(clumppDir, "/K7/CLUMPP.files/ClumppIndFile.output")
K7clumpp <- read.CLUMPP(K7filepath)

K8filepath <- paste0(clumppDir, "/K8/CLUMPP.files/ClumppIndFile.output")
K8clumpp <- read.CLUMPP(K8filepath)

K2_4 <- list(K2clumpp, K3clumpp, K4clumpp)
K5_8 <- list(K5clumpp, K6clumpp, K7clumpp, K8clumpp)
K2_8 <- list(K2clumpp, K3clumpp, K4clumpp, 
             K5clumpp, K6clumpp, K7clumpp, K8clumpp)

structure_plot(nInds = 180, klist = K2_4, Ks=(2:4), Kcolors = testColors)
structure_plot(nInds = 180, klist = K5_8, Ks=(5:8), Kcolors = testColors)
structure_plot(nInds = 180, klist = K2_8, Ks=(2:8), Kcolors = testColors)

# Designate groups beneath K charts. 1-85 are garden; 86-180 are wild
lineWidth <- 1.9; lineHeight <- rep(-0.1,2)
labelPositions <- c(42.5, 133); labelNames <- c("garden", "wild")

# Plot lines
lines(x = c(0.2,89), y = lineHeight, lwd = lineWidth, col = "black", xpd = NA)
lines(x = c(90.2,189), y = lineHeight, lwd = lineWidth, col = "black", xpd = NA)
# Add group labels
text(x=labelPositions, y=-0.2, srt=35, adj=1, xpd=TRUE, labels=labelNames, cex=1.2)
